<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detector de pH por Color</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    canvas {
      display: none;
    }
    #preview {
      max-width: 200px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <button id="abrirModal" style="font-size:18px; padding:10px 20px;">üì∑ Subir imagen de tira de pH</button>

  <!-- Modal -->
  <div id="modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div style="background:#fff; padding:20px; border-radius:8px; min-width:250px; max-width:90vw; text-align:center; position:relative;">
      <span id="cerrarModal" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px;">&times;</span>
      <h2>üì∑ Subir imagen de tira de pH</h2>
      <input type="file" id="imgInput" accept="image/*">
      <br>
      <img id="preview" src="#" alt="Vista previa" style="display:none; max-width:200px; margin-top:10px;">
      <canvas id="canvas"></canvas>
      <div id="contenidoModal" style="margin-top:15px;"></div>
    </div>
  </div>

  <script>
    document.getElementById('abrirModal').onclick = function() {
      document.getElementById('modal').style.display = "flex";
      // Limpiar estado anterior
      document.getElementById('imgInput').value = "";
      document.getElementById('preview').style.display = "none";
      document.getElementById('contenidoModal').innerHTML = "";
    };

    document.getElementById('cerrarModal').onclick = function() {
      document.getElementById('modal').style.display = "none";
    };

    document.getElementById('modal').onclick = function(e) {
      if (e.target === this) this.style.display = "none";
    };

    document.getElementById('imgInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const img = new Image();
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const preview = document.getElementById('preview');
      const modal = document.getElementById('modal');
      const contenidoModal = document.getElementById('contenidoModal');

      img.onload = function () {
        // Validaci√≥n: tira de pH suele ser rectangular y no muy peque√±a
        const minLado = 50;
        const proporcionMin = 2.2; // Relaci√≥n de aspecto m√≠nima (largo/m√≠nimo)
        const largo = Math.max(img.width, img.height);
        const corto = Math.min(img.width, img.height);

        if (corto < minLado || largo / corto < proporcionMin) {
          contenidoModal.innerHTML = "<span style='color:red;'>‚ö†Ô∏è Solo se permiten fotos de tiras de pH (imagen rectangular y suficientemente grande).</span>";
          preview.style.display = "none";
          return;
        }

        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        const centroX = Math.floor(img.width / 2);
        const centroY = Math.floor(img.height / 2);
        const pixel = ctx.getImageData(centroX, centroY, 1, 1).data;

        const r = pixel[0];
        const g = pixel[1];
        const b = pixel[2];

        let html = `üéØ Color en el centro: <b>RGB(${r}, ${g}, ${b})</b><br>`;
        const ph = identificarPH(r, g, b);
        html += `üß™ Estimaci√≥n de pH: <b>${ph}</b>`;

        contenidoModal.innerHTML = html;
        preview.style.display = "block";
      };

      img.src = URL.createObjectURL(file);
      preview.src = img.src;
    });

    function identificarPH(r, g, b) {
      const coloresPH = [
        { ph: 1, color: [255, 0, 0] },     // Rojo
        { ph: 3, color: [255, 128, 0] },   // Naranja
        { ph: 5, color: [255, 255, 0] },   // Amarillo
        { ph: 7, color: [0, 255, 0] },     // Verde
        { ph: 9, color: [0, 255, 255] },   // Verde azulado
        { ph: 11, color: [0, 0, 255] },    // Azul
        { ph: 13, color: [128, 0, 128] }   // P√∫rpura
      ];

      let mejorPH = null;
      let menorDistancia = Infinity;

      for (const entrada of coloresPH) {
        const [cr, cg, cb] = entrada.color;
        const distancia = Math.sqrt((r - cr) ** 2 + (g - cg) ** 2 + (b - cb) ** 2);
        if (distancia < menorDistancia) {
          menorDistancia = distancia;
          mejorPH = entrada.ph;
        }
      }

      return mejorPH;
    }
  </script>
</body>
</html>
