<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AquaGuard - Mapa de Calidad del Agua</title>
    <!--Estilos de Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--Carga los estilos base de Leaflet.js-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!--Font Awesome 6-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e6f7ff 0%, #f0f9ff 100%);
            margin: 0;
            padding: 0;
        }
        .header {
            background: linear-gradient(90deg, #0077b6 0%, #00b4d8 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
        }
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .logo-container img {
            height: 70px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 2px 8px #00b4d8aa);
        }
        .logo-container img:hover {
            transform: scale(1.08) rotate(-2deg);
        }
        .subtitle {
            color: #caf0f8;
            font-size: 1rem;
            text-shadow: 0 2px 8px #0077b688;
        }
        .map-container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 12px 18px;
            border: 2px solid #90e0ef;
            border-radius: 30px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            background: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0,180,216,0.08);
        }
        .search-box:focus {
            border-color: #0077b6;
            box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.18);
        }
        .btn-primary-custom {
            background: linear-gradient(90deg, #00b4d8 60%, #0077b6 100%);
            border: none;
            padding: 12px 28px;
            border-radius: 30px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(.4,2,.3,1);
            box-shadow: 0 6px 16px rgba(0,180,216,0.18);
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        .btn-primary-custom:hover {
            background: linear-gradient(90deg, #0096c7 60%, #0077b6 100%);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 12px 24px rgba(0,180,216,0.32);
        }
                .menu-superior {
            width: 100vw;
            background: linear-gradient(90deg, #0077b6 0%, #00b4d8 100%);
            color: #fff;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            flex-shrink: 0;
            position: relative;
            z-index: 2;
        }
        .logo-menu {
            padding: 10px 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: fadeInLeft 1s;
        }
        .logo-menu img {
            width: 120px;
            height: auto;
            display: block;
            filter: drop-shadow(0 2px 8px #00b4d8aa);
            transition: transform 0.3s;
        }
        .logo-menu img:hover {
            transform: scale(1.08) rotate(-2deg);
        }
        .menu-superior nav ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0 30px 0 0;
            gap: 10px;
        }
        .menu-superior nav ul li {
            margin: 0 16px;
        }
        .menu-superior nav ul li a {
            color: #fff;
            text-decoration: none;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 20px 0;
            display: block;
            transition: all 0.3s cubic-bezier(.4,2,.3,1);
            border-bottom: 2px solid transparent;
            letter-spacing: 1px;
            position: relative;
        }
        .menu-superior nav ul li a::after {
            content: '';
            display: block;
            width: 0;
            height: 2px;
            background: #90e0ef;
            transition: width .3s;
            position: absolute;
            left: 0;
            bottom: 0;
        }
        .menu-superior nav ul li a:hover {
            color: #90e0ef;
        }
        .menu-superior nav ul li a:hover::after {
            width: 100%;
        }
        #mapa {
            height: 600px;
            width: 100%;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(0,180,216,0.10);
            border: 1px solid #caf0f8;
        }
        .legend {
            padding: 12px 18px;
            background: white;
            border-radius: 14px;
            box-shadow: 0 6px 24px rgba(0,180,216,0.08);
            line-height: 1.6;
            font-size: 1rem;
            border: 2px solid #90e0ef;
        }
        .legend h4 {
            color: #0077b6;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        .legend i {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,180,216,0.18);
            border: 1px solid #90e0ef;
        }
        .info-panel {
            background: rgba(255,255,255,0.97);
            padding: 32px 28px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,180,216,0.10);
            margin-top: 30px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            animation: fadeInUp 1.2s;
        }
        .info-title {
            color: #0077b6;
            font-weight: 700;
            margin-bottom: 15px;
            font-size: 1.5rem;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px #90e0ef44;
        }
        .parameter-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .parameter-name {
            font-weight: 600;
            color: #333;
        }
        .parameter-value {
            color: #0077b6;
        }
        .quality-good {
            color: #28a745;
        }
        .quality-moderate {
            color: #ffc107;
        }
        .quality-bad {
            color: #dc3545;
        }
        .treatment-steps {
            margin-top: 20px;
        }
        .step-card {
            background: linear-gradient(120deg, #e6f7ff 60%, #fff 100%);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 4px solid #00b4d8;
            box-shadow: 0 6px 24px rgba(0,180,216,0.10);
        }
        .step-title {
            font-weight: 700;
            color: #0077b6;
            margin-bottom: 8px;
        }
        .step-desc {
            color: #555;
            font-size: 1rem;
        }
        .close-panel {
            float: right;
            cursor: pointer;
            color: #888;
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: -10px;
            margin-right: -10px;
            transition: color 0.2s;
        }
        .close-panel:hover {
            color: #0077b6;
        }
        /* Animaciones */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px);}
            to { opacity: 1; transform: translateY(0);}
        }
        /* Responsive */
        @media (max-width: 900px) {
            .map-container {
                padding: 12px;
            }
            .info-panel {
                padding: 18px 8px;
            }
        }
        @media (max-width: 700px) {
            .map-container {
                padding: 6px;
            }
            #mapa {
                height: 350px;
            }
            .info-panel {
                padding: 12px 4px;
            }
            .logo-container img {
                height: 48px;
            }
        }
    </style>
</head>
<body>    
    <div class="menu-superior">
        <div class="logo-menu">
            <img src="logo.png" alt="AquaGuard Logo" />
            <span style="font-size:1.3rem; font-weight:700; letter-spacing:1px; color:#90e0ef; text-shadow:0 2px 8px #0077b688;">AquaGuard</span>
        </div>
        <nav>
            <ul>
                <li><a href="index.html">Hogar</a></li>
                <li><a href="mapaContaminacion.html">Mapa</a></li>
                <li><a href="contenidoEducativo.html">Educación</a></li>
                <li><a href="comoUsar.html">Cómo Usar</a></li>
                <li><a href="juego.html">Juego</a></li>
            </ul>
        </nav>
    </div>
    <div style="width:100vw; background:linear-gradient(120deg,#f8f9fa 80%,#e6f7ff 100%); box-shadow:0 6px 24px rgba(0,180,216,0.08); text-align:center; padding:32px 0 18px 0; margin-bottom:0;">
        <h1 style="color:#0077b6; font-size:2rem; font-weight:800; margin-bottom:12px; letter-spacing:1px; text-shadow:0 2px 8px #90e0ef44;">
            Mapa Interactivo de Calidad del Agua
        </h1>
        <p style="font-size:1.15rem; color:#333; max-width:700px; margin:0 auto;">
            Explora la calidad del agua en ríos, lagos y presas de México. Usa el buscador para encontrar un sitio o cuerpo de agua, o utiliza tu ubicación para ver los cuerpos cercanos. Haz clic en los marcadores para ver información detallada y recomendaciones.
        </p>
    </div>

    <div class="map-container">
        <div class="search-container">
            <input type="text" id="searchInput" class="search-box" placeholder="Buscar por ubicación o nombre de río">
            <button id="searchButton" class="btn-primary-custom"><i class="fas fa-search"></i> Buscar</button>
            <button onclick="obtenerUbi()" class="btn-primary-custom"><i class="fas fa-location-arrow"></i> Mi Ubicación</button>
        </div>

        <div id="mapa"></div>

        <!-- Panel de información detallada de cuerpo de agua-->
        <div class="info-panel" id="infoPanel" style="display:none;">
            <span class="close-panel" onclick="cerrarPanel()">&times;</span>
            <h3 class="info-title" id="waterBodyTitle"></h3>
            <div id="waterBodyInfo"></div>
            
            <div class="treatment-steps" id="treatmentSteps">
                <h4><i class="fas fa-filter"></i> Recomendaciones de Tratamiento</h4>
                <div id="stepsContainer"></div>
            </div>
            
            <div class="mt-4">
                <h4><i class="fas fa-info-circle"></i> Información Adicional</h4>
                <div class="parameter-row">
                    <span class="parameter-name">Estado:</span>
                    <span class="parameter-value" id="aptaStatus"></span>
                </div>
                <div id="additionalInfo"></div>
            </div>
        </div>
    </div>

    <!--API del mapa-->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let map;
        let ubicacionMarker;
        let capasAgua;
        let cuerposAguaOriginal = null; 
        let currentLocation = [19.4326, -99.1332]; // Default to CDMX

        function initMap() {
            map = L.map('mapa').setView([23.6345, -102.5528], 6); // Centro y zoom para México
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4>Calidad del Agua</h4>
                    <div><i style="background:#28a745"></i> Buena</div>
                    <div><i style="background:#ffc107"></i> Moderada</div>
                    <div><i style="background:#dc3545"></i> Mala</div>
                `;
                return div;
            };
            legend.addTo(map);
            
            cargarCuerposAgua();
        }

        function cargarCuerposAgua() {
            fetch('Calidad_del_Agua_Superficial_p.json')
                .then(res => res.json())
                .then(data => {
                    const tiposPermitidos = [
                        "LÓTICO", "LÉNTICO", "LÉNTICO (HUMEDAL)", "LÓTICO (HUMEDAL)", 
                        "LÓTICO - COSTERO", "LENTICAS", "LENTICO", "LÉNTICO - COSTERO (HUMEDAL)",
                        "LÉNTICO - COSTERO", "LÉNTICO (ESTUDIO ESPECIAL)", "LENTICO (HUMEDAL)",
                        "LOTICO", "LÓTICO - COSTERO (HUMEDAL)", "LÓTICO (ESTUDIO ESPECIAL)",
                        "LÓTICO A - TIPO 1", "LÓTICO A - TIPO 2", "LÓTICO A - TIPO 3",
                        "LÓTICO A - TIPO 4", "LÓTICO A - TIPO 5", "LÓTICO A - TIPO 6",
                        "LÓTICO A - TIPO 7", "LÓTICO A - TIPO 7(HUMEDAL)", "LÓTICO A - TIPO 8",
                        "LÓTICO A - TIPO 9", "LÓTICO A - TIPO 10", "LÓTICO Y SEDIMENTOS"
                    ];

                    cuerposAguaOriginal = data.features.filter(feature =>
                        tiposPermitidos.includes(feature.properties.TIPO)
                    );
                    const cuerposAgua = {
                        type: "FeatureCollection",
                        features: cuerposAguaOriginal
                    };
                    //define el estilo de los marcadores según la calidad del agua
                    capasAgua = L.geoJSON(cuerposAgua, {
                        style: function(feature) {
                            let color;
                            switch (feature.properties.SEMAFORO) {
                                case "Verde": color = '#28a745'; break;
                                case "Amarillo": color = '#ffc107'; break;
                                case "Rojo": color = '#dc3545'; break;
                                default: color = '#007bff';
                            }
                            return {
                                color: color,
                                weight: 5,
                                opacity: 0.8,
                                fillOpacity: 0.5
                            };
                        },
                        pointToLayer: function(feature, latlng) {
                            return L.circleMarker(latlng, {
                                radius: 8,
                                fillColor: feature.properties.SEMAFORO === "Verde" ? '#28a745' :
                                          feature.properties.SEMAFORO === "Amarillo" ? '#ffc107' :
                                          feature.properties.SEMAFORO === "Rojo" ? '#dc3545' : '#007bff',
                                fillOpacity: 0.8
                            });
                        },
                        //Se define el tipo laguna/presa o río/arroyo según el tipo
                        onEachFeature: function(feature, layer) {
                            const props = feature.properties;
                            let nombre = props.SITIO || "Sin nombre";
                            let tipo = props.TIPO.toUpperCase().includes("LÉNTICO") || 
                                       props.TIPO.toUpperCase().includes("LENTICO") || 
                                       props.TIPO.toUpperCase().includes("LENTICAS") ? 
                                       "Laguna/Presa" : "Río/Arroyo";
                            //al hacer clic muestra un popup con la info completa 
                            layer.bindPopup(`
                                <b>${tipo}: ${nombre}</b><br>
                                <small>${props.MUNICIPIO}, ${props.ESTADO}</small><hr>
                                <b>Calidad:</b> <span style="color:${props.SEMAFORO === 'Verde' ? '#28a745' : 
                                                               props.SEMAFORO === 'Amarillo' ? '#ffc107' : 
                                                               props.SEMAFORO === 'Rojo' ? '#dc3545' : '#000'}">
                                ${props.SEMAFORO || "No disponible"}</span><br>
                                <b>Contaminantes:</b> ${props.CONTAMINANTES || "No detectados"}<br><br>
                                <button 
                                    class="btn btn-sm btn-primary ver-detalles-btn"
                                    data-nombre="${encodeURIComponent(nombre)}"
                                    data-tipo="${encodeURIComponent(tipo)}"
                                    data-props='${encodeURIComponent(JSON.stringify(props))}'
                                >
                                    Ver detalles completos
                                </button>
                            `);
                        }
                    }).addTo(map);
                })
                .catch(error => {
                    console.error("Error al cargar los datos:", error);
                    alert("Error al cargar los datos de los cuerpos de agua. Por favor intente más tarde.");
                });
        }

        function mostrarDetalles(nombre, tipo, propiedades) {
            document.getElementById('waterBodyTitle').textContent = `${tipo}: ${nombre}`;
            //Se construye el HTML para mostrar la información del cuerpo de agua
            let infoHTML = `
                <div class="parameter-row">
                    <span class="parameter-name">Ubicación:</span>
                    <span class="parameter-value">${propiedades.MUNICIPIO}, ${propiedades.ESTADO}</span>
                </div>
                <div class="parameter-row">
                    <span class="parameter-name">Calidad del agua:</span>
                    <span class="parameter-value ${propiedades.SEMAFORO === 'Verde' ? 'quality-good' : 
                                               propiedades.SEMAFORO === 'Amarillo' ? 'quality-moderate' : 
                                               'quality-bad'}">
                        ${propiedades.SEMAFORO}
                    </span>
                </div>
                <div class="parameter-row">
                    <span class="parameter-name">Contaminantes principales:</span>
                    <span class="parameter-value">${propiedades.CONTAMINANTES || 'No detectados'}</span>
                </div>
                <hr>`;
            //Se definen los parametros de calidad del agua y sus valores del cuerpo de agua
            const parametros = [
                { name: 'DBO (mg/L)', value: propiedades['DBO_mg/L'], quality: propiedades['CALIDAD_DBO'] },
                { name: 'DQO (mg/L)', value: propiedades['DQO_mg/L'], quality: propiedades['CALIDAD_DQO'] },
                { name: 'SST (mg/L)', value: propiedades['SST_mg/L'], quality: propiedades['CALIDAD_SST'] },
                { name: 'Coliformes Fecales (NMP/100mL)', value: propiedades['COLI_FEC_NMP_100mL'], quality: propiedades['CALIDAD_COLI_FEC'] },
                { name: 'E. Coli (NMP/100mL)', value: propiedades['E_COLI_NMP_100mL'], quality: propiedades['CALIDAD_E_COLI'] },
                { name: 'Oxígeno Disuelto (%)', value: propiedades['OD_PORC'], quality: propiedades['CALIDAD_OD_PORC'] },
                { name: 'Toxicidad Directa (48h)', value: propiedades['TOX_D_48_UT'], quality: propiedades['CALIDAD_TOX_D_48'] },
                { name: 'Toxicidad Vegetativa (15h)', value: propiedades['TOX_V_15_UT'], quality: propiedades['CALIDAD_TOX_V_15'] }
            ];
            //Se itera sobre los parámetros para agregarlos al HTML si tienen valor
            parametros.forEach(param => {
                if (param.value && param.value !== "") {
                    infoHTML += `
                        <div class="parameter-row">
                            <span class="parameter-name">${param.name}:</span>
                            <span class="parameter-value">${param.value} 
                                <small>(${param.quality})</small>
                            </span>
                        </div>
                    `;
                }
            });
            
            document.getElementById('waterBodyInfo').innerHTML = infoHTML;
            //determina si el agua es apta para consumo humano, riego, recreación, etc.
            const aptaPara = [];
            if (propiedades.SEMAFORO === 'Verde') {
                aptaPara.push('Consumo humano con tratamiento básico', 'Riego', 'Recreación');
                document.getElementById('aptaStatus').textContent = 'Apta con tratamiento';
                document.getElementById('aptaStatus').className = 'parameter-value quality-good';
            } else if (propiedades.SEMAFORO === 'Amarillo') {
                aptaPara.push('Riego con precaución', 'Usos industriales');
                document.getElementById('aptaStatus').textContent = 'Apta con restricciones';
                document.getElementById('aptaStatus').className = 'parameter-value quality-moderate';
            } else {
                document.getElementById('aptaStatus').textContent = 'No apta para uso humano';
                document.getElementById('aptaStatus').className = 'parameter-value quality-bad';
            }
            //Se generan las recomendaciones de tratamiento por etspas basadas en los contaminantes detectados 
            let stepsHTML = '';
            const contaminantes = (propiedades.CONTAMINANTES || '').split(',');
            
            if (contaminantes.includes('CF') || contaminantes.includes('EC')) {
                stepsHTML += `
                    <div class="step-card">
                        <div class="step-title">1. Desinfección</div>
                        <div class="step-desc">
                            Se detectaron coliformes fecales o E. coli. Recomendamos:
                            <ul>
                                <li>Cloración (1-2 mg/L de cloro libre residual)</li>
                                <li>Filtración con carbón activado para remover subproductos de desinfección</li>
                                <li>Considerar luz UV para eliminación de patógenos</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            if (parseFloat(propiedades['DBO_mg/L'] || 0) > 30 || parseFloat(propiedades['DQO_mg/L'] || 0) > 40) {
                stepsHTML += `
                    <div class="step-card">
                        <div class="step-title">2. Tratamiento de materia orgánica</div>
                        <div class="step-desc">
                            Niveles elevados de materia orgánica detectados. Recomendamos:
                            <ul>
                                <li>Coagulación-floculación con sulfato de aluminio o cloruro férrico</li>
                                <li>Filtración lenta en arena para remoción de partículas</li>
                                <li>Considerar humedales artificiales para tratamiento natural</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            if (parseFloat(propiedades['SST_mg/L'] || 0) > 50) {
                stepsHTML += `
                    <div class="step-card">
                        <div class="step-title">3. Remoción de sólidos</div>
                        <div class="step-desc">
                            Altos niveles de sólidos suspendidos. Recomendamos:
                            <ul>
                                <li>Sedimentación primaria con tiempo de retención de 2-4 horas</li>
                                <li>Filtros multimedia (arena, antracita, grava)</li>
                                <li>Membranas de microfiltración para partículas finas</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            if (stepsHTML === '') {
                stepsHTML = '<p>Basado en los parámetros medidos, no se detectaron contaminantes que requieran tratamiento especial.</p>';
            }
            
            document.getElementById('stepsContainer').innerHTML = stepsHTML;
            //Se agrega información educativa adicional sobre riesgos, tecnologías y conservación
            // Función para obtener la definición de cada contaminante
            function definicionContaminante(codigo) {
                switch (codigo.trim()) {
                    case 'CF':
                        return 'Coliformes Fecales (CF): Bacterias indicadoras de contaminación fecal, pueden causar enfermedades gastrointestinales.';
                    case 'EC':
                        return 'E. Coli (EC): Bacteria presente en heces, su presencia indica contaminación y riesgo sanitario.';
                    case 'DBO':
                        return 'Demanda Bioquímica de Oxígeno (DBO): Indica la cantidad de materia orgánica biodegradable en el agua.';
                    case 'DQO':
                        return 'Demanda Química de Oxígeno (DQO): Mide la cantidad total de materia orgánica y algunos inorgánicos.';
                    case 'SST':
                        return 'Sólidos Suspendidos Totales (SST): Partículas sólidas presentes en el agua, afectan la claridad y calidad.';
                    case 'OD':
                        return 'Oxígeno Disuelto (OD): Cantidad de oxígeno disponible en el agua para organismos acuáticos.';
                    case 'TOX_D_48':
                        return 'Toxicidad Directa 48h: Indica la toxicidad aguda para organismos en 48 horas.';
                    case 'TOX_V_15':
                        return 'Toxicidad Vegetativa 15h: Indica la toxicidad para vegetales en 15 horas.';
                    default:
                        return '';
                }
            }

            const contaminantesDetectados = (propiedades.CONTAMINANTES || '').split(',').map(c => c.trim()).filter(c => c);
            let definicionesHTML = '';
            if (contaminantesDetectados.length > 0) {
                definicionesHTML = '<ul style="text-align:left;">';
                contaminantesDetectados.forEach(codigo => {
                    const def = definicionContaminante(codigo);
                    if (def) {
                        definicionesHTML += `<li><strong>${codigo}:</strong> ${def}</li>`;
                    }
                });
                definicionesHTML += '</ul>';
            }

            let additionalHTML = `
                <div class="mt-3">
                    <h5><i class="fas fa-graduation-cap"></i> Información Educativa</h5>
                    <p><strong>Contaminantes detectados:</strong> ${propiedades.CONTAMINANTES || 'Ninguno'}</p>
                    ${definicionesHTML}
                    <p><strong>Riesgos:</strong> ${riesgosCuerpoAgua(propiedades)}</p>
                    <p><strong>Tecnologías recomendadas:</strong> ${tecnoCuerposAgua(propiedades)}</p>
                    <p><strong>Importancia de conservación:</strong> ${conservacionCuerposAgua(tipo)}</p>
                </div>
            `;


            document.getElementById('additionalInfo').innerHTML = additionalHTML;
            
            document.getElementById('infoPanel').style.display = 'block';
            document.getElementById('infoPanel').scrollIntoView({ behavior: 'smooth' });
        }
        //Funciones para generar la información educativa adicional
        function riesgosCuerpoAgua(propiedades) {
            const riesgos = [];
            if (propiedades['COLI_FEC_NMP_100mL'] > 200 || propiedades['E_COLI_NMP_100mL'] > 100) {
                riesgos.push('Riesgo de enfermedades gastrointestinales');
            }
            if (parseFloat(propiedades['DBO_mg/L'] || 0) > 30) {
                riesgos.push('Posible agotamiento de oxígeno en el agua');
            }
            if (propiedades['TOX_D_48_UT'] > 1 || propiedades['TOX_V_15_UT'] > 1) {
                riesgos.push('Posible toxicidad para organismos acuáticos');
            }
            return riesgos.length > 0 ? riesgos.join(', ') : 'Bajo riesgo según parámetros medidos';
        }

        function tecnoCuerposAgua(propiedades) {
            const techs = [];
            if (propiedades['COLI_FEC_NMP_100mL'] > 200) {
                techs.push('Desinfección UV');
            }
            if (parseFloat(propiedades['DBO_mg/L'] || 0) > 30) {
                techs.push('Reactores biológicos');
            }
            if (parseFloat(propiedades['SST_mg/L'] || 0) > 50) {
                techs.push('Filtración multimedia');
            }
            return techs.length > 0 ? techs.join(', ') : 'Tratamiento convencional suficiente';
        }

        function conservacionCuerposAgua(tipo) {
            if (tipo.includes('Río')) {
                return 'Los ríos son ecosistemas vitales que conectan diferentes hábitats. Su conservación es crucial para mantener la biodiversidad y proveer agua para comunidades.';
            } else {
                return 'Los cuerpos de agua lénticos (lagos, lagunas) son importantes reservorios de agua dulce y hábitats para especies acuáticas. Su protección ayuda a mantener el equilibrio ecológico.';
            }
        }

        function cerrarPanel() {
            document.getElementById('infoPanel').style.display = 'none';
        }

        function obtenerUbi() {
            if (ubicacionMarker) {
                map.removeLayer(ubicacionMarker);
            }
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        currentLocation = [position.coords.latitude, position.coords.longitude];
                        map.setView(currentLocation, 13);
                        
                        if (ubicacionMarker) {
                            map.removeLayer(ubicacionMarker);
                        }
                        
                        ubicacionMarker = L.marker(currentLocation, {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: '<i class="fas fa-user" style="color: #0077b6; font-size: 24px;"></i>',
                                iconSize: [24, 24]
                            })
                        }).addTo(map)
                        .bindPopup('Tu ubicación actual').openPopup();
                    },
                    function(error) {
                        console.error("Error al obtener ubicación:", error);
                        alert("No se pudo obtener tu ubicación. Usando ubicación predeterminada.");
                    }
                );
            } else {
                alert("La geolocalización no está soportada en tu navegador.");
            }
        }
        //evento de clic para el botón de "Buscar" por nombre o ubicacion de cuerpo de agua
        document.getElementById('searchButton').addEventListener('click', function() {
            const query = document.getElementById('searchInput').value.trim();
            buscarCuerposAgua(query);
        });
        //evento de clic para los botones de detalles del cuerpo de agua
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('ver-detalles-btn')) {
                // Evita que el popup se cierre
                e.preventDefault();
                e.stopPropagation();
                // Obtén los datos del botón
                const nombre = decodeURIComponent(e.target.getAttribute('data-nombre'));
                const tipo = decodeURIComponent(e.target.getAttribute('data-tipo'));
                const props = JSON.parse(decodeURIComponent(e.target.getAttribute('data-props')));
                mostrarDetalles(nombre, tipo, props);
            }
        });
        // Inicializa el mapa al cargar la página
        window.onload = initMap;
        //funcion para quitar acentos y normalizar cadenas de texto
        function quitarAcentos(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function buscarCuerposAgua(query) {
            if (!cuerposAguaOriginal) return;
            query = quitarAcentos(query.trim().toLowerCase());
            const resultados = cuerposAguaOriginal.filter(feature => {
                const props = feature.properties;
                return (
                    props.SITIO && quitarAcentos(props.SITIO.toLowerCase()).includes(query) ||
                    props.MUNICIPIO && quitarAcentos(props.MUNICIPIO.toLowerCase()).includes(query) ||
                    props.ESTADO && quitarAcentos(props.ESTADO.toLowerCase()).includes(query)
                );
            });
            // Elimina la capa anterior
            if (capasAgua) {
                map.removeLayer(capasAgua);
            }
            // Si no hay resultados, muestra todos
            const cuerposAgua = {
                type: "FeatureCollection",
                features: resultados.length > 0 ? resultados : cuerposAguaOriginal
            };
            capasAgua = L.geoJSON(cuerposAgua, {
                style: function(feature) {
                    let color;
                    switch (feature.properties.SEMAFORO) {
                        case "Verde": color = '#28a745'; break;
                        case "Amarillo": color = '#ffc107'; break;
                        case "Rojo": color = '#dc3545'; break;
                        default: color = '#007bff';
                    }
                    return {
                        color: color,
                        weight: 5,
                        opacity: 0.8,
                        fillOpacity: 0.5
                    };
                },
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 8,
                        fillColor: feature.properties.SEMAFORO === "Verde" ? '#28a745' :
                                  feature.properties.SEMAFORO === "Amarillo" ? '#ffc107' :
                                  feature.properties.SEMAFORO === "Rojo" ? '#dc3545' : '#007bff',
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: function(feature, layer) {
                    const props = feature.properties;
                    let nombre = props.SITIO || "Sin nombre";
                    let tipo = props.TIPO.toUpperCase().includes("LÉNTICO") || 
                               props.TIPO.toUpperCase().includes("LENTICO") || 
                               props.TIPO.toUpperCase().includes("LENTICAS") ? 
                               "Laguna/Presa" : "Río/Arroyo";
                    layer.bindPopup(`
                        <b>${tipo}: ${nombre}</b><br>
                        <small>${props.MUNICIPIO}, ${props.ESTADO}</small><hr>
                        <b>Calidad:</b> <span style="color:${props.SEMAFORO === 'Verde' ? '#28a745' : 
                                                   props.SEMAFORO === 'Amarillo' ? '#ffc107' : 
                                                   props.SEMAFORO === 'Rojo' ? '#dc3545' : '#000'}">
                ${props.SEMAFORO || "No disponible"}</span><br>
                <b>Contaminantes:</b> ${props.CONTAMINANTES || "No detectados"}<br><br>
                <button 
                    class="btn btn-sm btn-primary ver-detalles-btn"
                    data-nombre="${encodeURIComponent(nombre)}"
                    data-tipo="${encodeURIComponent(tipo)}"
                    data-props='${encodeURIComponent(JSON.stringify(props))}'
                >
                    Ver detalles completos
                </button>
            `);
                }
            }).addTo(map);
            // Centra el mapa en el primer resultado si existe
            if (resultados.length > 0 && resultados[0].geometry && resultados[0].geometry.coordinates) {
                const coords = resultados[0].geometry.coordinates;
                map.setView([coords[1], coords[0]], 13);
            }
        }
    </script>
</body>
</html>